{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "accountType": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Is Production?"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location"
            }
        },
        "servers_camsqlserver1_name": {
            "defaultValue": "[concat('camsqldb_', uniqueString(resourceGroup().id))]",
            "type": "String",
            "metadata":{
                "description": "MySQL server name"
            }
        },
        "administratorLogin": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "MySQL Database administrator login name"
            }
        },
        "administratorLoginPassword": {
            "type": "securestring",
            "minLength": 8,
            "maxLength": 128,
            "metadata": {
                "description": "MySQL Database administrator password"
            }
        },
        "serviceBusName": {
            "defaultValue": "[concat('camservicebus', uniqueString(resourceGroup().id))]",
            "type": "String",
            "metadata": {
                "description": "Service Bus Name"
            }
        },
        "cosmosName": {
            "defaultValue": "[concat('camcosmos', uniqueString(resourceGroup().id))]",
            "type": "String",
            "metadata": {
                "description": "Cosmos DB Name"
            }
        },
        "storageAccountName": {
            "defaultValue": "[concat('camstacct', uniqueString(resourceGroup().id))]",
            "type": "String",
            "maxLength": 24,
            "minLength": 2,
            "metadata": {
                "description": "Storage Account Name"
            }
        }
    },
    "variables": {
        "databaseName": "[concat(parameters('servers_camsqlserver1_name'), '/sys')]",
        "notebookWorkspacesName": "[concat(parameters('cosmosName'), '/default')]"
    },
    "resources": [
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2020-08-01-preview",
            "name": "[parameters('storageAccountName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_RAGRS",
                "tier": "Standard"
            },
            "kind": "StorageV2",
            "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": true,
                "allowSharedKeyAccess": true,
                "networkAcls": {
                    "bypass": "AzureServices",
                    "virtualNetworkRules": [],
                    "ipRules": [],
                    "defaultAction": "Allow"
                },
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                    "services": {
                        "file": {
                            "keyType": "Account",
                            "enabled": true
                        },
                        "blob": {
                            "keyType": "Account",
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                },
                "accessTier": "Hot"
            },
            "resources": [
                {
                    "type": "Microsoft.Storage/storageAccounts/encryptionScopes",
                    "apiVersion": "2020-08-01-preview",
                    "name": "[concat(parameters('storageAccountName'), '/DataAtRest')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    ],
                    "properties": {
                        "source": "Microsoft.Storage",
                        "state": "Enabled"
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices",
                    "apiVersion": "2020-08-01-preview",
                    "name": "[concat(parameters('storageAccountName'), '/default')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    ],
                    "sku": {
                        "name": "Standard_RAGRS",
                        "tier": "Standard"
                    },
                    "properties": {
                        "cors": {
                            "corsRules": []
                        },
                        "deleteRetentionPolicy": {
                            "enabled": false
                        }
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "2020-08-01-preview",
                            "name": "[concat(parameters('storageAccountName'), '/default/camconfigfilesblob')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                            ],
                            "properties": {
                                "defaultEncryptionScope": "$account-encryption-key",
                                "denyEncryptionScopeOverride": false,
                                "publicAccess": "Blob"
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "2020-08-01-preview",
                            "name": "[concat(parameters('storageAccountName'), '/default/dataatrestblob')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]",
                                "[resourceId('Microsoft.Storage/storageAccounts/encryptionScopes', parameters('storageAccountName'), 'DataAtRest')]",
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                                
                            ],
                            "properties": {
                                "defaultEncryptionScope": "DataAtRest",
                                "denyEncryptionScopeOverride": true,
                                "publicAccess": "Blob"
                            }
                        }
                    ]
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/fileServices",
                    "apiVersion": "2020-08-01-preview",
                    "name": "[concat(parameters('storageAccountName'), '/default')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    ],
                    "sku": {
                        "name": "Standard_RAGRS",
                        "tier": "Standard"
                    },
                    "properties": {
                        "protocolSettings": {
                            "smb": {}
                        },
                        "cors": {
                            "corsRules": []
                        },
                        "shareDeleteRetentionPolicy": {
                            "enabled": true,
                            "days": 7
                        }
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/queueServices",
                    "apiVersion": "2020-08-01-preview",
                    "name": "[concat(parameters('storageAccountName'), '/default')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    ],
                    "properties": {
                        "cors": {
                            "corsRules": []
                        }
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/tableServices",
                    "apiVersion": "2020-08-01-preview",
                    "name": "[concat(parameters('storageAccountName'), '/default')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    ],
                    "properties": {
                        "cors": {
                            "corsRules": []
                        }
                    }
                }
            ]
        },
        {
            "type": "Microsoft.DBforMySQL/servers",
            "apiVersion": "2017-12-01",
            "name": "[parameters('servers_camsqlserver1_name')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "B_Gen5_2",
                "tier": "Basic",
                "family": "Gen5",
                "capacity": 2
            },
            "properties": {
                "createMode": "Default",
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "storageProfile": {
                    "storageMB": 51200,
                    "backupRetentionDays": 7,
                    "geoRedundantBackup": "Disabled",
                    "storageAutogrow": "Enabled"
                },
                "version": "5.7",
                "sslEnforcement": "Disabled"
            },
            "resources": [
                {
                    "type": "Microsoft.DBForMySQL/servers/databases",
                    "apiVersion": "2017-12-01",
                    "name": "[variables('databaseName')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.DBforMySQL/servers', parameters('servers_camsqlserver1_name'))]"
                    ],
                    "properties": {
                        "charset": "utf8",
                        "collation": "utf8_general_ci"
                    }
                }
            ]
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "2020-09-01",
            "name": "[parameters('cosmosName')]",
            "location": "[parameters('location')]",
            "tags": {
                "defaultExperience": "Core (SQL)",
                "hidden-cosmos-mmspecial": "",
                "CosmosAccountType": "[if(equals(parameters('accountType'),'true'), 'Production', 'Non-Production')]"
            },
            "kind": "GlobalDocumentDB",
            "properties": {
                "publicNetworkAccess": "Enabled",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "isVirtualNetworkFilterEnabled": false,
                "virtualNetworkRules": [],
                "disableKeyBasedMetadataWriteAccess": false,
                "enableFreeTier": true,
                "enableAnalyticalStorage": false,
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": {
                    "defaultConsistencyLevel": "Session",
                    "maxIntervalInSeconds": 5,
                    "maxStalenessPrefix": 100
                },
                "locations": [
                    {
                        "locationName": "[parameters('location')]",
                        "provisioningState": "Succeeded",
                        "failoverPriority": 0,
                        "isZoneRedundant": false
                    }
                ],
                "cors": [],
                "capabilities": [],
                "ipRules": [],
                "backupPolicy": {
                    "type": "Periodic",
                    "periodicModeProperties": {
                        "backupIntervalInMinutes": 240,
                        "backupRetentionIntervalInHours": 8
                    }
                }
            },
            "resources": [
                {
                    "type": "Microsoft.DocumentDB/databaseAccounts/notebookWorkspaces",
                    "apiVersion": "2020-09-01",
                    "name": "[variables('notebookWorkspacesName')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosName'))]"
                    ]
                }
            ]
        },
        {
            "type": "Microsoft.ServiceBus/namespaces",
            "apiVersion": "2018-01-01-preview",
            "name": "[parameters('serviceBusName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard",
                "tier": "Standard"
            },
            "properties": {
                "zoneRedundant": false
            },
            "resources": [
                {
                    "type": "Microsoft.ServiceBus/namespaces/AuthorizationRules",
                    "apiVersion": "2017-04-01",
                    "name": "[concat(parameters('serviceBusName'), '/RootManageSharedAccessKey')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                    ],
                    "properties": {
                        "rights": [
                            "Listen",
                            "Manage",
                            "Send"
                        ]
                    }
                },
                {
                    "type": "Microsoft.ServiceBus/namespaces/networkRuleSets",
                    "apiVersion": "2018-01-01-preview",
                    "name": "[concat(parameters('serviceBusName'), '/default')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                    ],
                    "properties": {
                        "defaultAction": "Deny",
                        "virtualNetworkRules": [],
                        "ipRules": []
                    }
                },
                {
                    "type": "Microsoft.ServiceBus/namespaces/queues",
                    "apiVersion": "2018-01-01-preview",
                    "name": "[concat(parameters('serviceBusName'), '/etlqueue')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                    ],
                    "properties": {
                        "lockDuration": "PT30S",
                        "maxSizeInMegabytes": 1024,
                        "requiresDuplicateDetection": false,
                        "requiresSession": false,
                        "defaultMessageTimeToLive": "P14D",
                        "deadLetteringOnMessageExpiration": false,
                        "enableBatchedOperations": true,
                        "duplicateDetectionHistoryTimeWindow": "PT10M",
                        "maxDeliveryCount": 10,
                        "status": "Active",
                        "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
                        "enablePartitioning": false,
                        "enableExpress": false
                    }
                },
                {
                    "type": "Microsoft.ServiceBus/namespaces/topics",
                    "apiVersion": "2018-01-01-preview",
                    "name": "[concat(parameters('serviceBusName'), '/camrenewal')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                    ],
                    "properties": {
                        "defaultMessageTimeToLive": "P14D",
                        "maxSizeInMegabytes": 1024,
                        "requiresDuplicateDetection": false,
                        "duplicateDetectionHistoryTimeWindow": "PT10M",
                        "enableBatchedOperations": true,
                        "status": "Active",
                        "supportOrdering": true,
                        "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
                        "enablePartitioning": false,
                        "enableExpress": false
                    },
                    "resources": [
                        {
                            "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
                            "apiVersion": "2018-01-01-preview",
                            "name": "[concat(parameters('serviceBusName'), '/camrenewal/camrenewalsub')]",
                            "location": "[parameters('location')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusName'), 'camrenewal')]",
                                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                            ],
                            "properties": {
                                "lockDuration": "PT30S",
                                "requiresSession": false,
                                "defaultMessageTimeToLive": "P14D",
                                "deadLetteringOnMessageExpiration": false,
                                "deadLetteringOnFilterEvaluationExceptions": false,
                                "maxDeliveryCount": 100,
                                "status": "Active",
                                "enableBatchedOperations": true,
                                "autoDeleteOnIdle": "P14D"
                            },
                            "resources": [
                                {
                                    "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions/rules",
                                    "apiVersion": "2018-01-01-preview",
                                    "name": "[concat(parameters('serviceBusName'), '/camrenewal/camrenewalsub/$Default')]",
                                    "location": "[parameters('location')]",
                                    "dependsOn": [
                                        "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', parameters('serviceBusName'), 'camrenewal', 'camrenewalsub')]",
                                        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusName'), 'camrenewal')]",
                                        "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                                    ],
                                    "properties": {
                                        "action": {},
                                        "filterType": "SqlFilter",
                                        "sqlFilter": {
                                            "sqlExpression": "1=1",
                                            "compatibilityLevel": 20
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "type": "Microsoft.ServiceBus/namespaces/topics",
                    "apiVersion": "2018-01-01-preview",
                    "name": "[concat(parameters('serviceBusName'), '/cammapping')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                    ],
                    "properties": {
                        "defaultMessageTimeToLive": "P14D",
                        "maxSizeInMegabytes": 1024,
                        "requiresDuplicateDetection": false,
                        "duplicateDetectionHistoryTimeWindow": "PT10M",
                        "enableBatchedOperations": true,
                        "status": "Active",
                        "supportOrdering": true,
                        "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
                        "enablePartitioning": false,
                        "enableExpress": false
                    },
                    "resources": [
                        {
                            "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
                            "apiVersion": "2018-01-01-preview",
                            "name": "[concat(parameters('serviceBusName'), '/cammapping/cammappingsub')]",
                            "location": "[parameters('location')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusName'), 'cammapping')]",
                                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                            ],
                            "properties": {
                                "lockDuration": "PT30S",
                                "requiresSession": false,
                                "defaultMessageTimeToLive": "P14D",
                                "deadLetteringOnMessageExpiration": false,
                                "deadLetteringOnFilterEvaluationExceptions": false,
                                "maxDeliveryCount": 100,
                                "status": "Active",
                                "enableBatchedOperations": true,
                                "autoDeleteOnIdle": "P14D"
                            },
                            "resources": [
                                {
                                    "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions/rules",
                                    "apiVersion": "2018-01-01-preview",
                                    "name": "[concat(parameters('serviceBusName'), '/cammapping/cammappingsub/$Default')]",
                                    "location": "[parameters('location')]",
                                    "dependsOn": [
                                        "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', parameters('serviceBusName'), 'cammapping', 'cammappingsub')]",
                                        "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('serviceBusName'), 'cammapping')]",
                                        "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusName'))]"
                                    ],
                                    "properties": {
                                        "action": {},
                                        "filterType": "SqlFilter",
                                        "sqlFilter": {
                                            "sqlExpression": "1=1",
                                            "compatibilityLevel": 20
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
}