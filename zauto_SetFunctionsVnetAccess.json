{  // this set the "WEBSITE_CONTENTOVERVNET","name": "WEBSITE_VNET_ROUTE_ALL", "WEBSITE_DNS_SERVER", that are need only for Premium Deployment
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"Deploymenttype": {
			"type": "string",
			"allowedValues": ["Standard", "Premium"]
		},
		"ServiceBusResourceId": {
			"type": "string",
			"minLength": 36,
			"metadata": {
				"description": "Prosperoware Tenant Id will be provided by Prosperoware. Make sure to get the key before starting the installation."
			}
		},
		"EnvironmentStage": {
			"type": "string",
			"allowedValues": ["dev", "qa", "stg", "prod"]
		},
		"InstanceUniqueName": {
			"type": "string",
			"minLength": 3,
			"maxLength": 11
		},
		"TopLevelDomain": {
			"type": "string",
			"allowedValues": ["io", "eu", "com", "co.uk"]
		},
		"administratorLogin": {
			"type": "string",
			"minLength": 1,
			"metadata": {
				"description": "MySQL Database administrator login name"
			}
		},
		"administratorLoginPassword": {
			"type": "securestring",
			"minLength": 8,
			"maxLength": 128,
			"metadata": {
				"description": "MySQL Database administrator password"
			}
		},
		"vnetName": {
			"type": "string",
			"defaultValue": "VNet1",
			"metadata": {
				"description": "VNet name"
			}
		},
		"subnet1Name": {
			"type": "string",
			"defaultValue": "Subnet1",
			"metadata": {
				"description": "Subnet 1 Name"
			}
		},
		"subnet2Name": {
			"type": "string",
			"defaultValue": "Subnet2",
			"metadata": {
				"description": "Subnet 2 Name"
			}
		},
		"Features": {
			"type": "string",
			"allowedValues": ["ETL", "Content Sync", "Both"]
		},
		"ProsperowareTenantId": {
			"type": "string",
			"minLength": 36,
			"metadata": {
				"description": "Prosperoware Tenant Id will be provided by Prosperoware. Make sure to get the key before starting the installation."
			}
		},
		"ProsperowareEncryptedKey": {
			"type": "securestring",
			"minLength": 32,
			"metadata": {
				"description": "This encrypted Key will be provided by Prosperoware. Make sure to get the key before starting the installation."
			}
		},
		"ProsperowareSecretKey": {
			"type": "securestring",
			"minLength": 32,
			"metadata": {
				"description": "This secret Key will be provided by Prosperoware. Make sure to get the key before starting the installation."
			}
		},
		"branch": {
			"type": "string",
			"metadata": {
				"description": "branch"
			}
		},
		"repo": {
			"type": "string",
			"metadata": {
				"description": "repo"
			}
		},
		"WorkspaceResourceId": { 
			"type": "string",
			"metadata": {
				"description": "WorkspaceResourceId"
			}
		}
	},
	"variables": {
		"commonId": "[concat(parameters('InstanceUniqueName'), parameters('EnvironmentStage'), replace(parameters('TopLevelDomain'), '.', ''))]",
		"resourcesNamespace": "[concat(parameters('InstanceUniqueName'), parameters('EnvironmentStage'), '-', replace(parameters('TopLevelDomain'), '.', ''))]",
		"storageAccountName": "[concat('strg',variables('commonId'))]",
		"applicationConfigBucket": "[concat(variables('resourcesNamespace'), '-application-config')]",
		"mySqlServerName": "[concat('mysql-', variables('resourcesNamespace'))]",
		"cosmosName": "[concat('cosmos-', variables('resourcesNamespace'))]",
		"serviceBusName": "[concat('servicebus-', variables('resourcesNamespace'))]",
		"cosmosTenantdb": "[concat(variables('resourcesNamespace'),'-contentsync-tenant')]",
		"etlQueueName": "[concat(variables('resourcesNamespace'), '-etl-process-v1')]",
		"csQueueName": "[concat(variables('resourcesNamespace'), '-job-process-v1')]",
		"etlRenewalTopicName": "[concat(variables('resourcesNamespace'), '-etl_renewal_worker_start')]",
		"etlMappingTopicName": "[concat(variables('resourcesNamespace'), '-etl_mapping_worker_start')]",
		"etlActionTopicName": "[concat(variables('resourcesNamespace'), '-etl_document_action')]",
		"webServerName": "[concat(variables('resourcesNamespace'), '-api-app-srvr')]",
		"etlApiAppName": "[concat(variables('resourcesNamespace'), '-etl-api')]",
		"etlRenewalAppName": "[concat(variables('resourcesNamespace'), '-etl-renewal')]",
		"etlMappingAppName": "[concat(variables('resourcesNamespace'), '-etl-mapping')]",
		"etlProcessAppName": "[concat(variables('resourcesNamespace'), '-etl-process')]",
		"etlActionAppName": "[concat(variables('resourcesNamespace'), '-etl-action')]",
		"configAppName": "[concat(variables('resourcesNamespace'), '-etl-config')]",
		"csApiAppName": "[concat(variables('resourcesNamespace'), '-contentsync-api')]",
		"csProcessAppName": "[concat(variables('resourcesNamespace'), '-contentsync-process')]",
		"csRetryAppName": "[concat(variables('resourcesNamespace'), '-contentsync-retry')]",
		"Location": "[resourceGroup().location]",
		"apiVersion": "/api/v1",
		"authorizationRulesName": "RootManageSharedAccessKey",
		"etlApiAppInsightsName": "[concat(variables('resourcesNamespace'), '-etl-api')]",
		"etlRenewalAppInsightsName": "[concat(variables('resourcesNamespace'), '-etl-renewal')]",
		"etlMappingAppInsightsName": "[concat(variables('resourcesNamespace'), '-etl-mapping')]",
		"etlProcessAppInsightsName": "[concat(variables('resourcesNamespace'), '-etl-process')]",
		"etlActionAppInsightsName": "[concat(variables('resourcesNamespace'), '-etl-action')]",
		"configAppInsightsName": "[concat(variables('resourcesNamespace'), '-etl-config')]",
		"csApiAppInsightsName": "[concat(variables('resourcesNamespace'), '-contentsync-api')]",
		"csProcessAppInsightsName": "[concat(variables('resourcesNamespace'), '-contentsync-process')]",
		"csRetryAppInsightsName": "[concat(variables('resourcesNamespace'), '-contentsync-retry')]",
		"isETL": "[or(equals(parameters('Features'), 'ETL'), equals(parameters('Features'), 'Both'))]",
		"isCS": "[or(equals(parameters('Features'), 'Content Sync'), equals(parameters('Features'), 'Both'))]"
	},
	"resources": [
		//STORAGEACCOUNT
		{
			"type": "Microsoft.Storage/storageAccounts",
			"condition": "[equals(parameters('Deploymenttype'),'Premium')]",
			"apiVersion": "2021-06-01",
			"name": "[variables('storageAccountName')]",
			"location": "[variables('location')]",
			"sku": {
				"name": "Standard_RAGRS",
				"tier": "Standard"
			},
			"kind": "StorageV2",
			"properties": {
				"defaultToOAuthAuthentication": false,
				"allowCrossTenantReplication": true,
				"minimumTlsVersion": "TLS1_2",
				"allowBlobPublicAccess": true,
				"allowSharedKeyAccess": true,
				"networkAcls": {
					"resourceAccessRules": [],
					"bypass": "AzureServices",
					"virtualNetworkRules": [
						{
							"id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name'))]",
							"action": "Allow"
						},
						{
							"id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet2Name'))]",
							"action": "Allow"
						}
					],
					"ipRules": [],
					"defaultAction": "Deny"
				},
				"supportsHttpsTrafficOnly": true,
				"encryption": {
					"services": {
						"file": {
							"keyType": "Account",
							"enabled": true
						},
						"blob": {
							"keyType": "Account",
							"enabled": true
						}
					},
					"keySource": "Microsoft.Storage"
				},
				"accessTier": "Hot"
			},
			"resources": []
		},
		//MYSQL
		{
			"condition": "[variables('isETL')]",
			"type": "Microsoft.DBforMySQL/servers",
			"apiVersion": "2017-12-01",
			"name": "[variables('mySqlServerName')]",
			"location": "[variables('location')]",
			"sku": {
				"name": "[if(equals(parameters('Deploymenttype'),'Standard'),'B_Gen5_1','GP_Gen5_2')]",
				"tier": "[if(equals(parameters('Deploymenttype'),'Standard'),'Basic','GeneralPurpose')]",
				"family": "Gen5",
				"capacity": "[if(equals(parameters('Deploymenttype'),'Standard'),1,2)]"
			},
			"properties": {
				"createMode": "Default",
				"administratorLogin": "[parameters('administratorLogin')]",
				"administratorLoginPassword": "[parameters('administratorLoginPassword')]",
				"storageProfile": {
					"storageMB": 30720,
					"backupRetentionDays": 7,
					"geoRedundantBackup": "Disabled",
					"storageAutogrow": "Enabled"
				},
				"version": "5.7",
				"sslEnforcement": "[if(equals(parameters('Deploymenttype'),'Standard'),'Disabled','Enabled')]",
				"minimalTlsVersion": "[if(equals(parameters('Deploymenttype'),'Standard'),'TLSEnforcementDisabled','TLS1_2')]",//"TLSEnforcementDisabled",
				"infrastructureEncryption": "Disabled",
				"publicNetworkAccess": "[if(equals(parameters('Deploymenttype'),'Standard'),'Enabled','Disabled')]"
			},
			"resources": [
				{
					"condition": "[and(variables('isETL'),equals(parameters('Deploymenttype'),'Standard'))]",
					"type": "Microsoft.DBforMySQL/servers/firewallRules",
					"apiVersion": "2017-12-01",
					"name": "[concat(variables('mySqlServerName'), '/AllowAllWindowsAzureIps')]",
					"dependsOn": [
						"[resourceId('Microsoft.DBforMySQL/servers', variables('mySqlServerName'))]"
					],
					"properties": {
						"startIpAddress": "0.0.0.0",
						"endIpAddress": "0.0.0.0"
					}
				},
				{
					"condition": "[variables('isETL')]",
					"type": "Microsoft.DBForMySQL/servers/databases",
					"apiVersion": "2017-12-01",
					"name": "[concat(variables('mySqlServerName'), '/', variables('commonId'))]",
					"dependsOn": [
						"[resourceId('Microsoft.DBforMySQL/servers', variables('mySqlServerName'))]"
					],
					"properties": {
						"charset": "utf8",
						"collation": "utf8_general_ci"
					}
				}
			]
		},
		//etlApiAppInsightsName
		{
			"condition": "[variables('isETL')]",
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('etlApiAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('etlApiAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isETL')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('etlApiAppName')]",
			"location": "[variables('location')]",
            "tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('etlApiAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('etlApiAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('etlApiAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlApiAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlApiAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('etlApiAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('etlApiAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('etlApiAppName')]"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isETL')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('etlApiAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('etlApiAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		},
		//etlRenewalAppInsightsName
		{
            "condition": "[variables('isETL')]",
			"type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('etlRenewalAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('etlRenewalAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isETL')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('etlRenewalAppName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.insights/components', variables('etlRenewalAppInsightsName'))]"
			],
			"tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('etlRenewalAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('etlRenewalAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('etlRenewalAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlRenewalAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlRenewalAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('etlRenewalAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('etlRenewalAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('etlRenewalAppName')]"
						},
						{
							"name": "etl_renewal_manager_schedule",
							"value": "0 1 */8 * * *"
						},
						{
							"name": "etl_renewal_worker_subscription",
							"value": "[concat(variables('etlRenewalTopicName'), '-sub')]"
						},
						{
							"name": "etl_renewal_worker_topic",
							"value": "[variables('etlRenewalTopicName')]"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isETL')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('etlRenewalAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('etlRenewalAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		},
		//etlMappingAppInsightsName
		{
			"condition": "[variables('isETL')]",
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('etlMappingAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('etlMappingAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isETL')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('etlMappingAppName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.insights/components', variables('etlMappingAppInsightsName'))]",
				"[resourceId('Microsoft.Web/sites', variables('configAppName'))]"
			],
			"tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('etlMappingAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('etlMappingAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('etlMappingAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlMappingAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlMappingAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('etlMappingAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('etlMappingAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('etlMappingAppName')]"
						},
						{
							"name": "etl_mappingjob_manager_schedule",
							"value": "0 */2 * * * *"
						},
						{
							"name": "etl_mapping_worker_subscription",
							"value": "[concat(variables('etlMappingTopicName'), '-sub')]"
						},
						{
							"name": "etl_mapping_worker_topic",
							"value": "[variables('etlMappingTopicName')]"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isETL')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('etlMappingAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('etlMappingAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		},
		//etlProcessAppInsightsName
		{
            "condition": "[variables('isETL')]",
			"type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('etlProcessAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('etlProcessAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isETL')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('etlProcessAppName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.insights/components', variables('etlProcessAppInsightsName'))]",
				"[resourceId('Microsoft.Web/sites', variables('configAppName'))]"
			],
			 "tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('etlProcessAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"clientCertMode": "Optional",
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('etlProcessAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('etlProcessAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlProcessAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlProcessAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "cam_log_debug",
							"value": "false"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('etlProcessAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('etlProcessAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('etlProcessAppName')]"
						},
						{
							"name": "etl_job_process_dl_schedule",
							"value": "0 0/15 * * * *"
						},
						{
							"name": "etl_job_process_queue",
							"value": "[variables('etlQueueName')]"
						},
						{
							"name": "etlJobProcessHandler_timeout_sec",
							"value": "600"
						},
						{
							"name": "safe_remaining_time",
							"value": "60"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isETL')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('etlProcessAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('etlProcessAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		},
		//etlActionAppInsightsName
		{
			"condition": "[variables('isETL')]",
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('etlActionAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('etlActionAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isETL')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('etlActionAppName')]",
			"location": "[variables('location')]",
			"dependsOn":[
				"[resourceId('Microsoft.insights/components', variables('etlActionAppInsightsName'))]",
			],
			"tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('etlActionAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('etlActionAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('etlActionAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlActionAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('etlActionAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('etlActionAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('etlActionAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('etlActionAppName')]"
						},
						{
							"name": "etl_mapping_action_subscription",
							"value": "[concat(variables('etlActionTopicName'), '-sub')]"
						},
						{
							"name": "etl_mapping_action_topic",
							"value": "[variables('etlActionTopicName')]"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isETL')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('etlActionAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('etlActionAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		},
		//configAppInsightsName
		{
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('configAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('configAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('configAppName')]",
			"location": "[variables('Location')]",
			"dependsOn":[
				"[resourceId('Microsoft.insights/components', variables('configAppInsightsName'))]"
			],
			"tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('configAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('configAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('configAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('configAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('configAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "node"
						},
						{
							"name": "WEBSITE_NODE_DEFAULT_VERSION",
							"value": "~14"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "WEBSITE_CONTENTSHARE",
							"value": "[concat(toLower(variables('configAppName')), '9ded')]"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "mySqlServerName",
							"value": "[variables('mySqlServerName')]"
						},
						{
							"name": "mySqlUsername",
							"value": "[parameters('administratorLogin')]"
						},
						{
							"name": "mySqlPwd",
							"value": "[parameters('administratorLoginPassword')]"
						},
						{
							"name": "mySqlDatabaseName",
							"value": "[variables('commonId')]"
						},
						{
							"name": "etl_job_process_queue",
							"value": "[variables('etlQueueName')]"
						},
						{
							"name": "contentsync_job_process_queue",
							"value": "[variables('csQueueName')]"
						},
						{
							"name": "cosmos_accountname",
							"value": "[variables('cosmosName')]"
						},
						{
							"name": "cosmos_accesskey",
							"value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosName')),'2020-09-01').primaryMasterKey]"
						},
						{
							"name": "cosmos_csdbname",
							"value": "[variables('commonId')]"
						},
						{
							"name": "servicebus_namespace",
							"value": "[variables('serviceBusName')]"
						},
						{
							"name": "storage_accountkey",
							"value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value]"
						},
						{
							"name": "applicationConfigBucket",
							"value": "[variables('applicationConfigBucket')]"
						},
						{
							"name": "cosmos_tenant_container",
							"value": "[variables('cosmosTenantdb')]"
						},
						{
							"name": "etl_api_url",
							"value": "[concat(variables('etlApiAppName'), '.azurewebsites.net')]"
						},
						{
							"name": "Prosperoware_tenantId",
							"value": "[parameters('ProsperowareTenantId')]"
						},
						{
							"name": "Prosperoware_encryptedKey",
							"value": "[parameters('ProsperowareEncryptedKey')]"
						},
						{
							"name": "Prosperoware_secretKey",
							"value": "[parameters('ProsperowareSecretKey')]"
						},
						{
							"name": "product_features",
							"value": "[parameters('Features')]"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			}
		},
		//csApiAppInsightsName
		{
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('csApiAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('csApiAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isCS')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('csApiAppName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.insights/components', variables('csApiAppInsightsName'))]",
				"[resourceId('Microsoft.Web/sites', variables('configAppName'))]"
			],
			"tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('csApiAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('csApiAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('csApiAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('csApiAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('csApiAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('csApiAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('csApiAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('csApiAppName')]"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isCS')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('csApiAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('csApiAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		},
		//csProcessAppInsightsName
		{
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('csProcessAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('csProcessAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isCS')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('csProcessAppName')]",
			"location": "[variables('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.insights/components', variables('csProcessAppInsightsName'))]",
				"[resourceId('Microsoft.Web/sites', variables('configAppName'))]"
			],
			"tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('csProcessAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('csProcessAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('csProcessAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('csProcessAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('csProcessAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "cam_log_debug",
							"value": "false"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('csProcessAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('csProcessAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('csProcessAppName')]"
						},
						{
							"name": "contentsync_job_process_dl_schedule",
							"value": "0 0/15 * * * *"
						},
						{
							"name": "contentsync_job_process_queue",
							"value": "[variables('csQueueName')]"
						},
						{
							"name": "contentSyncJobProcessHandler_timeout_sec",
							"value": "600"
						},
						{
							"name": "safe_remaining_time",
							"value": "60"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isCS')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('csProcessAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('csProcessAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		},
		//csRetryAppInsightsName
		{
            "type": "microsoft.insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('csRetryAppInsightsName')]",
            "location": "[variables('Location')]",
            "properties": {
				"ApplicationId": "[variables('csRetryAppInsightsName')]",
                "Request_Source": "IbizaWebAppExtensionCreate",
                "Flow_Type": "Redfield",
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('WorkspaceResourceId')]"
            }
        },
		{
			"condition": "[variables('isCS')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2018-11-01",
			"name": "[variables('csRetryAppName')]",
			"location": "[variables('location')]",
			"dependsOn":[
				"[resourceId('Microsoft.insights/components', variables('csRetryAppInsightsName'))]"
			],
			"tags": {
                "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.insights/components', variables('csRetryAppInsightsName'))]"
            },
			"kind": "functionapp",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat(variables('csRetryAppName'), '.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat(variables('csRetryAppName'), '.scm.azurewebsites.net')]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webServerName'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"siteConfig": {
					"appSettings": [
						{
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('csRetryAppInsightsName'))).InstrumentationKey]"
                        },
                        {
                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
							"value": "[reference(resourceId('Microsoft.Insights/components', variables('csRetryAppInsightsName'))).ConnectionString]"
                        },
						{
							"name": "application_group",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "AzureWebJobsServiceBusConnection",
							"value": "[concat('Endpoint=sb://', variables('serviceBusName'), '.servicebus.windows.net/;SharedAccessKeyName=', variables('authorizationRulesName') ,';SharedAccessKey=', listKeys(parameters('ServiceBusResourceId'), '2017-04-01').primaryKey)]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value)]"
						},
						{
							"name": "JAVA_OPTS",
							"value": "-Dfile.encoding=UTF-8"
						},
						{
							"name": "WEBSITE_USE_PLACEHOLDER",
							"value": "0"
						},
						{
							"name": "cam_log_debug",
							"value": "false"
						},
						{
							"name": "config_basepath",
							"value": "[concat('az:', variables('applicationConfigBucket'))]"
						},
						{
							"name": "cs_ddt_prefix",
							"value": "[variables('resourcesNamespace')]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~3"
						},
						{
							"name": "FUNCTIONS_WORKER_JAVA_LOAD_APP_LIBS",
							"value": "1"
						},
						{
							"name": "FUNCTIONS_WORKER_RUNTIME",
							"value": "java"
						},
						{
							"name": "lambda_profile",
							"value": "[parameters('EnvironmentStage')]"
						},
						{
							"name": "storage_accountname",
							"value": "[variables('storageAccountName')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2019-06-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
						},
						{
							"name": "api_base_url",
							"value": "[concat('https://', variables('csRetryAppName'), '.azurewebsites.net', variables('apiVersion'))]"
						},
						{
							"name": "service_id",
							"value": "[variables('csRetryAppName')]"
						},
						{
							"name": "service_name",
							"value": "[variables('csRetryAppName')]"
						},
						{
							"name": "contentsync_retry_schedule",
							"value": "0 0/15 * * * *"
						},
						{
							"name": "contentSyncRetryHandler_timeout_sec",
							"value": "600"
						},
						{
							"name": "WEBSITE_CONTENTOVERVNET",
							"value": "1"
						},
						{
							"name": "WEBSITE_VNET_ROUTE_ALL",
							"value": "1"
						},
						{
							"name": "WEBSITE_DNS_SERVER",
							"value": "168.63.129.16"
						},
						{
							"name": "WEBSITE_RUN_FROM_PACKAGE",
							"value": "1"
						}
					],
					"vnetRouteAllEnabled": "[if(equals(parameters('Deploymenttype'),'Standard'),'false','true')]",
					"ftpsState": "[if(equals(parameters('Deploymenttype'),'Standard'),'FtpsOnly','Disabled')]"
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": false,
				"clientCertEnabled": true,
				"clientCertMode": "Optional",
				"hostNamesDisabled": false,
				"containerSize": 1536,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"virtualNetworkSubnetId": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnet1Name')))]",
				"keyVaultReferenceIdentity": "[if(equals(parameters('Deploymenttype'),'Standard'),null(),'SystemAssigned')]",
				"functionsRuntimeScaleMonitoringEnabled": 1
			},
			"resources": [
				{
					"condition": "[variables('isCS')]",
					"type": "Microsoft.Web/sites/providers/diagnosticsettings",
					"apiVersion": "2017-05-01-preview",
					"location": "[variables('location')]",
					"name": "[concat(variables('csRetryAppName'), '/Microsoft.Insights/function-logs')]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('csRetryAppName'))]"
					],
					"properties": {
						"storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
						"logs": [
							{
								"category": "FunctionAppLogs",
								"enabled": true,
								"retentionPolicy": {
									"enabled": true,
									"days": 7
								}
							}
						]
					}
				}
			]
		}
	],
	"outputs": {}
}
